services:
  # Application Web Streamlit
  - type: web
    name: amazon-scraping-dashboard
    env: python
    region: frankfurt
    plan: free
    buildCommand: |
      pip install --upgrade pip
      pip install -r requirements.txt
    startCommand: streamlit run app.py --server.port=$PORT --server.address=0.0.0.0 --server.headless=true --server.enableCORS=false
    
    envVars:
      - key: PYTHON_VERSION
        value: 3.11.0
      - key: EMAIL_SENDER
        sync: false
      - key: EMAIL_PASSWORD
        sync: false
      - key: EMAIL_RECIPIENT
        sync: false
    
    # Configuration pour installer Chrome/Chromium
    buildCommand: |
      # Installer les dépendances système pour Chrome
      apt-get update && apt-get install -y \
        wget \
        gnupg \
        ca-certificates \
        fonts-liberation \
        libasound2 \
        libatk-bridge2.0-0 \
        libatk1.0-0 \
        libatspi2.0-0 \
        libcups2 \
        libdbus-1-3 \
        libdrm2 \
        libgbm1 \
        libgtk-3-0 \
        libnspr4 \
        libnss3 \
        libwayland-client0 \
        libxcomposite1 \
        libxdamage1 \
        libxfixes3 \
        libxkbcommon0 \
        libxrandr2 \
        xdg-utils \
        chromium \
        chromium-driver
      
      # Installer les dépendances Python
      pip install --upgrade pip
      pip install -r requirements.txt

  # Cron Job - Scraping Quotidien
  - type: cron
    name: scraping-quotidien
    env: python
    schedule: "0 2 * * *"  # Tous les jours à 2h du matin UTC
    buildCommand: pip install -r requirements.txt
    startCommand: python -c "from scraper import run_scraping_job; run_scraping_job('laptop', 100, 5)"
    
    envVars:
      - key: EMAIL_SENDER
        sync: false
      - key: EMAIL_PASSWORD
        sync: false
      - key: EMAIL_RECIPIENT
        sync: false

  # Cron Job - Alertes Quotidiennes
  - type: cron
    name: alertes-quotidiennes
    env: python
    schedule: "0 8 * * *"  # Tous les jours à 8h du matin UTC
    buildCommand: pip install -r requirements.txt
    startCommand: python -c "from alertes import run_alerte_job; run_alerte_job()"
    
    envVars:
      - key: EMAIL_SENDER
        sync: false
      - key: EMAIL_PASSWORD
        sync: false
      - key: EMAIL_RECIPIENT
        sync: false
